"use strict";
var path = require('path');
var URLHelper_1 = require('../helpers/URLHelper');
var PathHelper_1 = require('../helpers/PathHelper');
var SiteFile_1 = require('../files/SiteFile');
var TemplateFile_1 = require('../files/TemplateFile');
var AssetManager_1 = require('../components/AssetManager');
var ContentFile_1 = require('../files/ContentFile');
var StringHelper_1 = require('../helpers/StringHelper');
var DEFAULT_PAGE_EXTENSION = '.html';
var DEFAULT_INDEX_PAGE = 'index' + DEFAULT_PAGE_EXTENSION;
var ProjectBuilder = (function () {
    function ProjectBuilder(projectSettings) {
        this.settings = projectSettings;
        this.config = this.settings.config.get();
    }
    ProjectBuilder.prototype.build = function () {
        var assetManager = new AssetManager_1.AssetManager(this.settings);
        assetManager.setupListeners();
        assetManager.copyAssets();
        this.preparePages(this.config.pages, []);
    };
    ProjectBuilder.prototype.preparePages = function (pages, currentPath) {
        var length = pages.length;
        for (var i = 0; i < length; i++) {
            this.preparePage(pages[i], currentPath);
        }
    };
    ProjectBuilder.prototype.preparePage = function (page, currentPath) {
        var relativeUriArray = ProjectBuilder.extractRelativeUriArray(page);
        var contentFile;
        if (page.content) {
            var contentPath = PathHelper_1.PathHelper.join(this.settings.contentPath, page.content);
            contentFile = new ContentFile_1.ContentFile(contentPath);
            contentFile.reload();
        }
        if (page.template) {
            var relativePagePathArray = this.determinePagePathArray(relativeUriArray);
            var relativeUrl = URLHelper_1.URLHelper.join(relativePagePathArray);
            var fullPagePath = PathHelper_1.PathHelper.join(this.settings.buildPath, currentPath, relativePagePathArray);
            var urlGenerator = URLHelper_1.URLHelper.prepareUrlGenerator(relativeUrl);
            for (var i = 0; i < page.menus.length; i++) {
                var menu = page.menus[i];
                var itemTitle = this.determineMenuItemTitle(menu, contentFile.getAttributes());
                if (itemTitle === undefined) {
                    itemTitle = path.basename(fullPagePath, DEFAULT_PAGE_EXTENSION);
                }
            }
            var locals = {
                url: urlGenerator,
                asset: '',
                menus: {},
                hash: StringHelper_1.StringHelper.randomString(8),
                site_url: this.config.site_url,
                site_root: this.config.site_root,
            };
            var templatePath = PathHelper_1.PathHelper.join(this.settings.templatePath, page.template);
            var templateFile = new TemplateFile_1.TemplateFile(templatePath);
            templateFile.reload();
            var siteFile = new SiteFile_1.SiteFile(fullPagePath, templateFile);
            siteFile.rebuild();
            siteFile.write();
        }
        else {
        }
    };
    ProjectBuilder.extractRelativeUriArray = function (page) {
        var relativePathArray;
        if (page.uri !== undefined) {
            relativePathArray = URLHelper_1.URLHelper.split(page.uri);
        }
        else if (page.content !== undefined) {
            relativePathArray = URLHelper_1.URLHelper.split(PathHelper_1.PathHelper.stripExtension(page.content));
        }
        else if (page.template !== undefined) {
            relativePathArray = URLHelper_1.URLHelper.split(PathHelper_1.PathHelper.stripExtension(page.template));
        }
        else {
            throw new Error('Could not determine page path!');
        }
        return relativePathArray;
    };
    ProjectBuilder.prototype.determinePagePathArray = function (uriArray) {
        var isIndex = uriArray.length === 0 || (uriArray.length === 1 && uriArray[0] === 'index');
        if (isIndex) {
            return [DEFAULT_INDEX_PAGE];
        }
        var lastIndex = uriArray.length - 1;
        if (this.config.explicit_html_extensions) {
            uriArray[lastIndex] = uriArray[lastIndex] + DEFAULT_PAGE_EXTENSION;
        }
        else {
            uriArray.push(DEFAULT_INDEX_PAGE);
        }
        return uriArray;
    };
    ProjectBuilder.prototype.determineMenuItemTitle = function (menu, contentAttributes) {
        var title;
        if (menu.title_key && contentAttributes[menu.title_key]) {
            title = contentAttributes[menu.title_key];
        }
        else if (menu.title) {
            title = menu.title;
        }
        else if (contentAttributes.menu_title) {
            title = contentAttributes.menu_title;
        }
        else if (contentAttributes.title) {
            title = contentAttributes.title;
        }
        return title;
    };
    return ProjectBuilder;
}());
exports.ProjectBuilder = ProjectBuilder;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb3JlL1Byb2plY3RCdWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFNQSxJQUFZLElBQUksV0FBTSxNQUFNLENBQUMsQ0FBQTtBQUc3QiwwQkFBd0Isc0JBQXNCLENBQUMsQ0FBQTtBQUMvQywyQkFBeUIsdUJBQXVCLENBQUMsQ0FBQTtBQUNqRCx5QkFBeUMsbUJBQW1CLENBQUMsQ0FBQTtBQUM3RCw2QkFBMkIsdUJBQXVCLENBQUMsQ0FBQTtBQUNuRCw2QkFBMkIsNEJBQTRCLENBQUMsQ0FBQTtBQUN4RCw0QkFBMEIsc0JBQXNCLENBQUMsQ0FBQTtBQUNqRCw2QkFBMkIseUJBQXlCLENBQUMsQ0FBQTtBQUVyRCxJQUFNLHNCQUFzQixHQUFHLE9BQU8sQ0FBQztBQUN2QyxJQUFNLGtCQUFrQixHQUFHLE9BQU8sR0FBRyxzQkFBc0IsQ0FBQztBQWM1RDtJQUtJLHdCQUFZLGVBQWdDO1FBQ3hDLElBQUksQ0FBQyxRQUFRLEdBQUcsZUFBZSxDQUFDO1FBQ2hDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDN0MsQ0FBQztJQUVNLDhCQUFLLEdBQVo7UUFDSSxJQUFJLFlBQVksR0FBRyxJQUFJLDJCQUFZLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ25ELFlBQVksQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUM5QixZQUFZLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDMUIsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRU8scUNBQVksR0FBcEIsVUFBcUIsS0FBb0IsRUFBRSxXQUFxQjtRQUM1RCxJQUFJLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO1FBQzFCLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdB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ImZpbGUiOiJzcmMvY29yZS9Qcm9qZWN0QnVpbGRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGF1dGhvciBUaW11ciBLdXpoYWdhbGl5ZXYgPHRpbS5rdXpoQGdtYWlsLmNvbT5cbiAqIEBjb3B5cmlnaHQgMjAxN1xuICogQGxpY2Vuc2UgR1BMLTMuMFxuICovXG5cbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQge1Byb2plY3RTZXR0aW5nc30gZnJvbSAnLi4vY29tcG9uZW50cy9Qcm9qZWN0U2V0dGluZ3MnO1xuaW1wb3J0IHtJQ29uZmlnUGFnZSwgSUNvbmZpZywgSUNvbmZpZ01lbnV9IGZyb20gJy4uL2NvbXBvbmVudHMvQ29uZmlnJztcbmltcG9ydCB7VVJMSGVscGVyfSBmcm9tICcuLi9oZWxwZXJzL1VSTEhlbHBlcic7XG5pbXBvcnQge1BhdGhIZWxwZXJ9IGZyb20gJy4uL2hlbHBlcnMvUGF0aEhlbHBlcic7XG5pbXBvcnQge1NpdGVGaWxlLCBJQmxpdHpQYWdlTG9jYWxzfSBmcm9tICcuLi9maWxlcy9TaXRlRmlsZSc7XG5pbXBvcnQge1RlbXBsYXRlRmlsZX0gZnJvbSAnLi4vZmlsZXMvVGVtcGxhdGVGaWxlJztcbmltcG9ydCB7QXNzZXRNYW5hZ2VyfSBmcm9tICcuLi9jb21wb25lbnRzL0Fzc2V0TWFuYWdlcic7XG5pbXBvcnQge0NvbnRlbnRGaWxlfSBmcm9tICcuLi9maWxlcy9Db250ZW50RmlsZSc7XG5pbXBvcnQge1N0cmluZ0hlbHBlcn0gZnJvbSAnLi4vaGVscGVycy9TdHJpbmdIZWxwZXInO1xuXG5jb25zdCBERUZBVUxUX1BBR0VfRVhURU5TSU9OID0gJy5odG1sJztcbmNvbnN0IERFRkFVTFRfSU5ERVhfUEFHRSA9ICdpbmRleCcgKyBERUZBVUxUX1BBR0VfRVhURU5TSU9OO1xuXG5leHBvcnQgaW50ZXJmYWNlIElVcmxHZW5lcmF0b3Ige1xuICAgIChpZDogc3RyaW5nKTogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElBc3NldFBhdGhHZW5lcmF0b3Ige1xuICAgIChhc3NldFBhdGg6IHN0cmluZyk6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJQ29udGVudEdlbmVyYXRvciB7XG4gICAgKHJhd0NvbnRlbnQ6IHN0cmluZyk6IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIFByb2plY3RCdWlsZGVyIHtcblxuICAgIHByaXZhdGUgc2V0dGluZ3M6IFByb2plY3RTZXR0aW5ncztcbiAgICBwcml2YXRlIGNvbmZpZzogSUNvbmZpZztcblxuICAgIGNvbnN0cnVjdG9yKHByb2plY3RTZXR0aW5nczogUHJvamVjdFNldHRpbmdzKSB7XG4gICAgICAgIHRoaXMuc2V0dGluZ3MgPSBwcm9qZWN0U2V0dGluZ3M7XG4gICAgICAgIHRoaXMuY29uZmlnID0gdGhpcy5zZXR0aW5ncy5jb25maWcuZ2V0KCk7XG4gICAgfVxuXG4gICAgcHVibGljIGJ1aWxkKCkge1xuICAgICAgICBsZXQgYXNzZXRNYW5hZ2VyID0gbmV3IEFzc2V0TWFuYWdlcih0aGlzLnNldHRpbmdzKTtcbiAgICAgICAgYXNzZXRNYW5hZ2VyLnNldHVwTGlzdGVuZXJzKCk7XG4gICAgICAgIGFzc2V0TWFuYWdlci5jb3B5QXNzZXRzKCk7XG4gICAgICAgIHRoaXMucHJlcGFyZVBhZ2VzKHRoaXMuY29uZmlnLnBhZ2VzLCBbXSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwcmVwYXJlUGFnZXMocGFnZXM6IElDb25maWdQYWdlW10sIGN1cnJlbnRQYXRoOiBzdHJpbmdbXSkge1xuICAgICAgICBsZXQgbGVuZ3RoID0gcGFnZXMubGVuZ3RoO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICB0aGlzLnByZXBhcmVQYWdlKHBhZ2VzW2ldLCBjdXJyZW50UGF0aCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHByZXBhcmVQYWdlKHBhZ2U6IElDb25maWdQYWdlLCBjdXJyZW50UGF0aDogc3RyaW5nW10pIHtcbiAgICAgICAgbGV0IHJlbGF0aXZlVXJpQXJyYXkgPSBQcm9qZWN0QnVpbGRlci5leHRyYWN0UmVsYXRpdmVVcmlBcnJheShwYWdlKTtcblxuICAgICAgICAvLyBUT0RPOiBSZWN1cnNpdmVseSBwcmVwYXJlIHBhZ2VzL2RpcmVjdG9yaWVzXG5cbiAgICAgICAgbGV0IGNvbnRlbnRGaWxlOiBDb250ZW50RmlsZTtcblxuICAgICAgICBpZiAocGFnZS5jb250ZW50KSB7XG5cbiAgICAgICAgICAgIGxldCBjb250ZW50UGF0aCA9IFBhdGhIZWxwZXIuam9pbih0aGlzLnNldHRpbmdzLmNvbnRlbnRQYXRoLCBwYWdlLmNvbnRlbnQpO1xuICAgICAgICAgICAgY29udGVudEZpbGUgPSBuZXcgQ29udGVudEZpbGUoY29udGVudFBhdGgpO1xuICAgICAgICAgICAgY29udGVudEZpbGUucmVsb2FkKCk7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwYWdlLnRlbXBsYXRlKSB7XG5cbiAgICAgICAgICAgIGxldCByZWxhdGl2ZVBhZ2VQYXRoQXJyYXkgPSB0aGlzLmRldGVybWluZVBhZ2VQYXRoQXJyYXkocmVsYXRpdmVVcmlBcnJheSk7XG4gICAgICAgICAgICBsZXQgcmVsYXRpdmVVcmwgPSBVUkxIZWxwZXIuam9pbihyZWxhdGl2ZVBhZ2VQYXRoQXJyYXkpO1xuICAgICAgICAgICAgbGV0IGZ1bGxQYWdlUGF0aCA9IFBhdGhIZWxwZXIuam9pbih0aGlzLnNldHRpbmdzLmJ1aWxkUGF0aCwgY3VycmVudFBhdGgsIHJlbGF0aXZlUGFnZVBhdGhBcnJheSk7XG5cbiAgICAgICAgICAgIGxldCB1cmxHZW5lcmF0b3IgPSBVUkxIZWxwZXIucHJlcGFyZVVybEdlbmVyYXRvcihyZWxhdGl2ZVVybCk7XG5cbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFnZS5tZW51cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGxldCBtZW51ID0gcGFnZS5tZW51c1tpXTtcbiAgICAgICAgICAgICAgICBsZXQgaXRlbVRpdGxlID0gdGhpcy5kZXRlcm1pbmVNZW51SXRlbVRpdGxlKG1lbnUsIGNvbnRlbnRGaWxlLmdldEF0dHJpYnV0ZXMoKSk7XG4gICAgICAgICAgICAgICAgaWYgKGl0ZW1UaXRsZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW1UaXRsZSA9IHBhdGguYmFzZW5hbWUoZnVsbFBhZ2VQYXRoLCBERUZBVUxUX1BBR0VfRVhURU5TSU9OKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBsb2NhbHM6IElCbGl0elBhZ2VMb2NhbHMgPSB7XG4gICAgICAgICAgICAgICAgdXJsOiB1cmxHZW5lcmF0b3IsXG4gICAgICAgICAgICAgICAgYXNzZXQ6ICcnLFxuICAgICAgICAgICAgICAgIG1lbnVzOiB7fSxcbiAgICAgICAgICAgICAgICBoYXNoOiBTdHJpbmdIZWxwZXIucmFuZG9tU3RyaW5nKDgpLFxuICAgICAgICAgICAgICAgIHNpdGVfdXJsOiB0aGlzLmNvbmZpZy5zaXRlX3VybCxcbiAgICAgICAgICAgICAgICBzaXRlX3Jvb3Q6IHRoaXMuY29uZmlnLnNpdGVfcm9vdCxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGxldCB0ZW1wbGF0ZVBhdGggPSBQYXRoSGVscGVyLmpvaW4odGhpcy5zZXR0aW5ncy50ZW1wbGF0ZVBhdGgsIHBhZ2UudGVtcGxhdGUpO1xuICAgICAgICAgICAgbGV0IHRlbXBsYXRlRmlsZSA9IG5ldyBUZW1wbGF0ZUZpbGUodGVtcGxhdGVQYXRoKTtcbiAgICAgICAgICAgIHRlbXBsYXRlRmlsZS5yZWxvYWQoKTtcblxuICAgICAgICAgICAgbGV0IHNpdGVGaWxlID0gbmV3IFNpdGVGaWxlKGZ1bGxQYWdlUGF0aCwgdGVtcGxhdGVGaWxlKTtcbiAgICAgICAgICAgIHNpdGVGaWxlLnJlYnVpbGQoKTtcbiAgICAgICAgICAgIHNpdGVGaWxlLndyaXRlKCk7XG5cbiAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBleHRyYWN0UmVsYXRpdmVVcmlBcnJheShwYWdlOiBJQ29uZmlnUGFnZSk6IHN0cmluZ1tdIHtcbiAgICAgICAgbGV0IHJlbGF0aXZlUGF0aEFycmF5O1xuICAgICAgICBpZiAocGFnZS51cmkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgcmVsYXRpdmVQYXRoQXJyYXkgPSBVUkxIZWxwZXIuc3BsaXQocGFnZS51cmkpO1xuICAgICAgICB9IGVsc2UgaWYgKHBhZ2UuY29udGVudCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICByZWxhdGl2ZVBhdGhBcnJheSA9IFVSTEhlbHBlci5zcGxpdChQYXRoSGVscGVyLnN0cmlwRXh0ZW5zaW9uKHBhZ2UuY29udGVudCkpO1xuICAgICAgICB9IGVsc2UgaWYgKHBhZ2UudGVtcGxhdGUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgcmVsYXRpdmVQYXRoQXJyYXkgPSBVUkxIZWxwZXIuc3BsaXQoUGF0aEhlbHBlci5zdHJpcEV4dGVuc2lvbihwYWdlLnRlbXBsYXRlKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBkZXRlcm1pbmUgcGFnZSBwYXRoIScpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZWxhdGl2ZVBhdGhBcnJheTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGRldGVybWluZVBhZ2VQYXRoQXJyYXkodXJpQXJyYXk6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xuICAgICAgICBsZXQgaXNJbmRleCA9IHVyaUFycmF5Lmxlbmd0aCA9PT0gMCB8fCAodXJpQXJyYXkubGVuZ3RoID09PSAxICYmIHVyaUFycmF5WzBdID09PSAnaW5kZXgnKTtcbiAgICAgICAgaWYgKGlzSW5kZXgpIHtcbiAgICAgICAgICAgIHJldHVybiBbREVGQVVMVF9JTkRFWF9QQUdFXTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgbGFzdEluZGV4ID0gdXJpQXJyYXkubGVuZ3RoIC0gMTtcbiAgICAgICAgaWYgKHRoaXMuY29uZmlnLmV4cGxpY2l0X2h0bWxfZXh0ZW5zaW9ucykge1xuICAgICAgICAgICAgdXJpQXJyYXlbbGFzdEluZGV4XSA9IHVyaUFycmF5W2xhc3RJbmRleF0gKyBERUZBVUxUX1BBR0VfRVhURU5TSU9OO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdXJpQXJyYXkucHVzaChERUZBVUxUX0lOREVYX1BBR0UpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB1cmlBcnJheTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGRldGVybWluZU1lbnVJdGVtVGl0bGUobWVudTogSUNvbmZpZ01lbnUsIGNvbnRlbnRBdHRyaWJ1dGVzOiBhbnkpOiBzdHJpbmcge1xuICAgICAgICBsZXQgdGl0bGU7XG4gICAgICAgIGlmIChtZW51LnRpdGxlX2tleSAmJiBjb250ZW50QXR0cmlidXRlc1ttZW51LnRpdGxlX2tleV0pIHtcbiAgICAgICAgICAgIHRpdGxlID0gY29udGVudEF0dHJpYnV0ZXNbbWVudS50aXRsZV9rZXldO1xuICAgICAgICB9IGVsc2UgaWYgKG1lbnUudGl0bGUpIHtcbiAgICAgICAgICAgIHRpdGxlID0gbWVudS50aXRsZTtcbiAgICAgICAgfSBlbHNlIGlmIChjb250ZW50QXR0cmlidXRlcy5tZW51X3RpdGxlKSB7XG4gICAgICAgICAgICB0aXRsZSA9IGNvbnRlbnRBdHRyaWJ1dGVzLm1lbnVfdGl0bGU7XG4gICAgICAgIH0gZWxzZSBpZiAoY29udGVudEF0dHJpYnV0ZXMudGl0bGUpIHtcbiAgICAgICAgICAgIHRpdGxlID0gY29udGVudEF0dHJpYnV0ZXMudGl0bGU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRpdGxlO1xuICAgIH1cblxufVxuIl19
