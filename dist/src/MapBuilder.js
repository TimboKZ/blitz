"use strict";
var path = require('path');
var SiteDirectory_1 = require('./files/SiteDirectory');
var TemplateFile_1 = require('./files/TemplateFile');
var ContentFile_1 = require('./files/ContentFile');
var URLHelper_1 = require('./helpers/URLHelper');
var StringHelper_1 = require('./helpers/StringHelper');
var FileGenerator_1 = require('./files/FileGenerator');
var SiteFile_1 = require('./files/SiteFile');
var MapBuilder = (function () {
    function MapBuilder(config, projectRoot, buildPath) {
        this.config = config;
        this.projectRoot = projectRoot;
        this.contentRoot = path.join(projectRoot, 'content');
        this.templateRoot = path.join(projectRoot, 'template');
        this.buildPath = buildPath;
        this.directoryMap = {};
    }
    MapBuilder.prototype.build = function () {
        this.directoryMap[''] = new SiteDirectory_1.SiteDirectory(this.buildPath);
        this.parsePages('', this.config.get().pages);
    };
    MapBuilder.prototype.parsePages = function (currentUri, pages) {
        var pageCount = pages.length;
        for (var i = 0; i < pageCount; i++) {
            var page = pages[i];
            var contentFile = void 0;
            var templateFile = void 0;
            if (page.content) {
                contentFile = new ContentFile_1.ContentFile(this.contentRoot, page.content);
                contentFile.reload();
            }
            if (page.template) {
                var pageUri = void 0;
                if (page.uri && !URLHelper_1.URLHelper.empty(page.uri)) {
                    pageUri = URLHelper_1.URLHelper.trimSlashes(URLHelper_1.URLHelper.join(currentUri, page.uri));
                }
                else {
                    pageUri = URLHelper_1.URLHelper.trimSlashes(URLHelper_1.URLHelper.join(currentUri, StringHelper_1.StringHelper.stripExtension(page.template)));
                }
                var fileUri = this.fileFromUri(pageUri);
                templateFile = new TemplateFile_1.TemplateFile(this.templateRoot, page.template);
                templateFile.reload();
                var fileGenerator = new FileGenerator_1.FileGenerator(contentFile, templateFile);
                var siteFile = new SiteFile_1.SiteFile(this.buildPath, URLHelper_1.URLHelper.split(path.dirname(fileUri)), path.basename(fileUri), fileGenerator);
            }
        }
    };
    MapBuilder.prototype.getDirectory = function (uri) {
        var strippedUri = URLHelper_1.URLHelper.trimSlashes(uri);
        if (!this.directoryMap[strippedUri]) {
            this.directoryMap[''] = new SiteDirectory_1.SiteDirectory(this.buildPath);
        }
    };
    MapBuilder.prototype.fileFromUri = function (uri) {
        return URLHelper_1.URLHelper.fileFromUri(uri, this.config.get().explicit_html_extensions);
    };
    return MapBuilder;
}());
exports.MapBuilder = MapBuilder;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LFlBQVksR0FBRyxJQUFJLDJCQUFZLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ2xFLFlBQVksQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDdEIsSUFBSSxhQUFhLEdBQUcsSUFBSSw2QkFBYSxDQUFDLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQztnQkFDakUsSUFBSSxRQUFRLEdBQUcsSUFBSSxtQkFBUSxDQUN2QixJQUFJLENBQUMsU0FBUyxFQUNkLHFCQUFTLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsRUFDdEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsRUFDdEIsYUFBYSxDQUNoQixDQUFDO1lBQ04sQ0FBQztRQUNMLENBQUM7SUFDTCxDQUFDO0lBRU8saUNBQVksR0FBcEIsVUFBcUIsR0FBVztRQUM1QixJQUFJLFdBQVcsR0FBRyxxQkFBUyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM3QyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2xDLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSw2QkFBYSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUM5RCxDQUFDO0lBRUwsQ0FBQztJQUVPLGdDQUFXLEdBQW5CLFVBQW9CLEdBQVc7UUFDM0IsTUFBTSxDQUFDLHFCQUFTLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLHdCQUF3QixDQUFDLENBQUM7SUFDbEYsQ0FBQztJQUNMLGlCQUFDO0FBQUQsQ0ExRkEsQUEwRkMsSUFBQTtBQTFGWSxrQkFBVSxhQTBGdEIsQ0FBQSIsImZpbGUiOiJzcmMvTWFwQnVpbGRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGZpbGUgQWxsIGludGVyZmFjZXMgYW5kIGNsYXNzZXMgcmVsYXRlZCB0byB0aGUgZ2VuZXJhdGlvbiBvZiB0aGUgbWFwIG9mIHRoZSBzaXRlXG4gKiBAYXV0aG9yIFRpbXVyIEt1emhhZ2FsaXlldiA8dGltLmt1emhAZ21haWwuY29tPlxuICogQGNvcHlyaWdodCAyMDE2XG4gKiBAbGljZW5zZSBHUEwtMy4wXG4gKiBAc2luY2UgMC4yLjBcbiAqL1xuXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHtDb25maWcsIElDb25maWdQYWdlfSBmcm9tICcuL0NvbmZpZyc7XG5pbXBvcnQge1NpdGVEaXJlY3Rvcnl9IGZyb20gJy4vZmlsZXMvU2l0ZURpcmVjdG9yeSc7XG5pbXBvcnQge0lDaGlsZERpcmVjdG9yeU1hcH0gZnJvbSAnLi9maWxlcy9HZW5lcmljRGlyZWN0b3J5JztcbmltcG9ydCB7VGVtcGxhdGVGaWxlfSBmcm9tICcuL2ZpbGVzL1RlbXBsYXRlRmlsZSc7XG5pbXBvcnQge0NvbnRlbnRGaWxlfSBmcm9tICcuL2ZpbGVzL0NvbnRlbnRGaWxlJztcbmltcG9ydCB7VVJMSGVscGVyfSBmcm9tICcuL2hlbHBlcnMvVVJMSGVscGVyJztcbmltcG9ydCB7U3RyaW5nSGVscGVyfSBmcm9tICcuL2hlbHBlcnMvU3RyaW5nSGVscGVyJztcbmltcG9ydCB7RmlsZUdlbmVyYXRvcn0gZnJvbSAnLi9maWxlcy9GaWxlR2VuZXJhdG9yJztcbmltcG9ydCB7ZmlsZX0gZnJvbSAnbW9jay1mcyc7XG5pbXBvcnQge1NpdGVGaWxlfSBmcm9tICcuL2ZpbGVzL1NpdGVGaWxlJztcblxuLyoqXG4gKiBAY2xhc3MgQ2xhc3MgcmVzcG9uc2libGUgZm9yIGJ1aWxkaW5nIG9mIHRoZSBtYXAgcmVsYXRpbmcgdGhlIGNvbmZpZyBhbmQgdGhlIGZpbGUgc3lzdGVtIHRvIHRoZSBzaXRlXG4gKiBAc2luY2UgMC4yLjBcbiAqL1xuZXhwb3J0IGNsYXNzIE1hcEJ1aWxkZXIge1xuICAgIC8qKlxuICAgICAqIEluc3RhbmNlIG9mIHRoZSBjb25maWcgdXNlZCB0byBnZW5lcmF0ZSB0aGUgc2l0ZVxuICAgICAqIEBzaW5jZSAwLjIuMFxuICAgICAqL1xuICAgIHByaXZhdGUgY29uZmlnOiBDb25maWc7XG5cbiAgICAvKipcbiAgICAgKiBGb2xkZXIgaW4gd2hpY2ggYGFzc2V0c2AsIGBjb250ZW50YCwgYHRlbXBsYXRlc2AsIGV0Yy4gYXJlIGxvY2F0ZWRcbiAgICAgKiBAc2luY2UgMC4yLjBcbiAgICAgKi9cbiAgICBwcml2YXRlIHByb2plY3RSb290OiBzdHJpbmc7XG5cbiAgICBwcml2YXRlIGNvbnRlbnRSb290OiBzdHJpbmc7XG4gICAgcHJpdmF0ZSB0ZW1wbGF0ZVJvb3Q6IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIEZvbGRlciBpbiB3aGljaCB0aGUgc2l0ZSB3aWxsIGJlIGdlbmVyYXRlZFxuICAgICAqIEBzaW5jZSAwLjIuMFxuICAgICAqL1xuICAgIHByaXZhdGUgYnVpbGRQYXRoOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBNYXAgb2YgdGhlIGRpcmVjdG9yaWVzIGdlbmVyYXRlZCB3aGlsZSB0aGUgYnVpbGRlciBpcyBydW5uaW5nXG4gICAgICogQHNpbmNlIDAuMi4wXG4gICAgICovXG4gICAgcHJpdmF0ZSBkaXJlY3RvcnlNYXA6IElDaGlsZERpcmVjdG9yeU1hcDtcblxuICAgIC8qKlxuICAgICAqIE1hcEJ1aWxkZXIgY29uc3RydWN0b3JcbiAgICAgKiBAc2luY2UgMC4yLjBcbiAgICAgKi9cbiAgICBwdWJsaWMgY29uc3RydWN0b3IoY29uZmlnOiBDb25maWcsIHByb2plY3RSb290OiBzdHJpbmcsIGJ1aWxkUGF0aDogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgICAgICB0aGlzLnByb2plY3RSb290ID0gcHJvamVjdFJvb3Q7XG4gICAgICAgIHRoaXMuY29udGVudFJvb3QgPSBwYXRoLmpvaW4ocHJvamVjdFJvb3QsICdjb250ZW50Jyk7XG4gICAgICAgIHRoaXMudGVtcGxhdGVSb290ID0gcGF0aC5qb2luKHByb2plY3RSb290LCAndGVtcGxhdGUnKTtcbiAgICAgICAgdGhpcy5idWlsZFBhdGggPSBidWlsZFBhdGg7XG4gICAgICAgIHRoaXMuZGlyZWN0b3J5TWFwID0ge307XG4gICAgfVxuXG4gICAgcHVibGljIGJ1aWxkKCkge1xuICAgICAgICB0aGlzLmRpcmVjdG9yeU1hcFsnJ10gPSBuZXcgU2l0ZURpcmVjdG9yeSh0aGlzLmJ1aWxkUGF0aCk7XG4gICAgICAgIHRoaXMucGFyc2VQYWdlcygnJywgdGhpcy5jb25maWcuZ2V0KCkucGFnZXMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcGFyc2VQYWdlcyhjdXJyZW50VXJpOiBzdHJpbmcsIHBhZ2VzOiBJQ29uZmlnUGFnZVtdKSB7XG4gICAgICAgIGxldCBwYWdlQ291bnQgPSBwYWdlcy5sZW5ndGg7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFnZUNvdW50OyBpKyspIHtcbiAgICAgICAgICAgIGxldCBwYWdlID0gcGFnZXNbaV07XG4gICAgICAgICAgICBsZXQgY29udGVudEZpbGU7XG4gICAgICAgICAgICBsZXQgdGVtcGxhdGVGaWxlO1xuICAgICAgICAgICAgaWYgKHBhZ2UuY29udGVudCkge1xuICAgICAgICAgICAgICAgIGNvbnRlbnRGaWxlID0gbmV3IENvbnRlbnRGaWxlKHRoaXMuY29udGVudFJvb3QsIHBhZ2UuY29udGVudCk7XG4gICAgICAgICAgICAgICAgY29udGVudEZpbGUucmVsb2FkKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocGFnZS50ZW1wbGF0ZSkge1xuICAgICAgICAgICAgICAgIGxldCBwYWdlVXJpO1xuICAgICAgICAgICAgICAgIGlmIChwYWdlLnVyaSAmJiAhVVJMSGVscGVyLmVtcHR5KHBhZ2UudXJpKSkge1xuICAgICAgICAgICAgICAgICAgICBwYWdlVXJpID0gVVJMSGVscGVyLnRyaW1TbGFzaGVzKFVSTEhlbHBlci5qb2luKGN1cnJlbnRVcmksIHBhZ2UudXJpKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcGFnZVVyaSA9IFVSTEhlbHBlci50cmltU2xhc2hlcyhcbiAgICAgICAgICAgICAgICAgICAgICAgIFVSTEhlbHBlci5qb2luKGN1cnJlbnRVcmksIFN0cmluZ0hlbHBlci5zdHJpcEV4dGVuc2lvbihwYWdlLnRlbXBsYXRlKSlcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGV0IGZpbGVVcmkgPSB0aGlzLmZpbGVGcm9tVXJpKHBhZ2VVcmkpO1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlRmlsZSA9IG5ldyBUZW1wbGF0ZUZpbGUodGhpcy50ZW1wbGF0ZVJvb3QsIHBhZ2UudGVtcGxhdGUpO1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlRmlsZS5yZWxvYWQoKTtcbiAgICAgICAgICAgICAgICBsZXQgZmlsZUdlbmVyYXRvciA9IG5ldyBGaWxlR2VuZXJhdG9yKGNvbnRlbnRGaWxlLCB0ZW1wbGF0ZUZpbGUpO1xuICAgICAgICAgICAgICAgIGxldCBzaXRlRmlsZSA9IG5ldyBTaXRlRmlsZShcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5idWlsZFBhdGgsXG4gICAgICAgICAgICAgICAgICAgIFVSTEhlbHBlci5zcGxpdChwYXRoLmRpcm5hbWUoZmlsZVVyaSkpLFxuICAgICAgICAgICAgICAgICAgICBwYXRoLmJhc2VuYW1lKGZpbGVVcmkpLFxuICAgICAgICAgICAgICAgICAgICBmaWxlR2VuZXJhdG9yXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0RGlyZWN0b3J5KHVyaTogc3RyaW5nKTogU2l0ZURpcmVjdG9yeSB7XG4gICAgICAgIGxldCBzdHJpcHBlZFVyaSA9IFVSTEhlbHBlci50cmltU2xhc2hlcyh1cmkpO1xuICAgICAgICBpZiAoIXRoaXMuZGlyZWN0b3J5TWFwW3N0cmlwcGVkVXJpXSkge1xuICAgICAgICAgICAgdGhpcy5kaXJlY3RvcnlNYXBbJyddID0gbmV3IFNpdGVEaXJlY3RvcnkodGhpcy5idWlsZFBhdGgpO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGZpbGVGcm9tVXJpKHVyaTogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBVUkxIZWxwZXIuZmlsZUZyb21VcmkodXJpLCB0aGlzLmNvbmZpZy5nZXQoKS5leHBsaWNpdF9odG1sX2V4dGVuc2lvbnMpO1xuICAgIH1cbn1cbiJdfQ==
